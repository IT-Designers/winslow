stages:
  - test
  - build
  - deploy
  - downstream

before_script:
  - git submodule sync --recursive
  - git submodule update --init --recursive

variables:
  WINSLOW_API_TS_URL: "$NEXUS_RAW_WINSLOW_URL/api/build/winslow-api_$CI_COMMIT_SHORT_SHA.ts"
  WINSLOW_API_TS_URL_LATEST: "$NEXUS_RAW_WINSLOW_URL/api/winslow-api.ts"
  WINSLOW_API_TS_URL_TAGGED: "$NEXUS_RAW_WINSLOW_URL/api/winslow-api.ts"

test:
  stage: test
  image: maven:3.8.5-openjdk-17
  tags:
    - docker
  script:
    - mvn clean test verify
    - mv application/target/site/jacoco coverage-report
    - awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, " instructions covered"; print 100*covered/instructions, "% covered" }' coverage-report/jacoco.csv
  coverage: '/([\d]+\.[\d]+) % covered/'

build:
  stage: build
  image: maven:3.8.5-openjdk-17
  tags:
    - docker
  script:
    - sed -i "s/external__BUILD_DATE/$(date '+%Y-%m-%d %H:%M:%S')/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
    - sed -i "s/external__COMMIT_HASH_LONG/$CI_COMMIT_SHA/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
    - sed -i "s/external__COMMIT_HASH_SHORT/$CI_COMMIT_SHORT_SHA/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
    - mvn clean test verify package
    - cp application/target/winslow*.jar .
    - mv application/target/site/jacoco coverage-report
    - awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, " instructions covered"; print 100*covered/instructions, "% covered" }' coverage-report/jacoco.csv
    - mvn -pl .,api package
    - cp api/target/winslow*.jar .
    - (cd api; mvn typescript-generator:generate)
    - cp api/target/typescript-generator/winslow-api.ts .
    - ls -lah
    #- cp target/winslow*.jar .
    - if [ "$CI_COMMIT_REF_NAME" == "master" ]; then mvn -s settings.xml -pl .,api deploy; fi
  coverage: '/([\d]+\.[\d]+) % covered/'
  artifacts:
    name: winslow-$CI_COMMIT_SHORT_SHA
    paths:
     - winslow*.jar
     - coverage-report
     - winslow-api.ts


publish-on-artifact-share:
  stage: deploy
  tags:
    - shell
  script:
    - export WINSLOW_API_TS_URL="$(eval echo $WINSLOW_API_TS_URL)"
    - export WINSLOW_API_TS_URL_LATEST="$(eval echo $WINSLOW_API_TS_URL_LATEST)"
    - export WINSLOW_API_TS_URL_TAGGED="$(eval echo $WINSLOW_API_TS_URL_TAGGED)"
    - export ARCHIVE=winslow-api.ts
    - curl -u "$NEXUS_LOGIN" --upload-file $ARCHIVE "$WINSLOW_API_TS_URL"
    - if [ "$CI_COMMIT_REF_NAME" == "master" ]; then curl -u "$NEXUS_LOGIN" --upload-file $ARCHIVE "$WINSLOW_API_TS_URL_LATEST"; fi
    - if [ "$CI_COMMIT_TAG" != "" ]; then curl -u "$NEXUS_LOGIN" --upload-file $ARCHIVE "$WINSLOW_API_TS_URL_TAGGED"; fi

deploy:
  stage: deploy
  only:
    refs:
      - master
  tags:
    - dockerbuilder
  script:
#    - ./build-docker-image.sh
    - ls -lah .
    - docker build . -t $DOCKER_REGISTRY_WINSLOW/winslow/component-server
    - docker login -u $DOCKER_REGISTRY_WINSLOW_USERNAME -p $DOCKER_REGISTRY_WINSLOW_PASSWORD $DOCKER_REGISTRY_WINSLOW
    - docker push $DOCKER_REGISTRY_WINSLOW/winslow/component-server
  dependencies:
    - build

pages:
  stage: deploy
  only:
    refs:
      - master
  before_script: []
  script:
#    - ./build-docker-image.sh
    - mv coverage-report public
  dependencies:
    - build
  artifacts:
    paths:
      - public/

release:
  stage: downstream
  only:
    refs:
      - master
  trigger:
    project: trafficobservation/winslow/docker
    strategy: depend
