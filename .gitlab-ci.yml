stages:
  - build
  - deploy
  - downstream

build:
  stage: build
  image: node
  tags:
    - docker
  variables:
    NODE_OPTIONS: "--openssl-legacy-provider"
  script:
#    - npm install -g -ng
    - npm install
    - npm run build -- --prod --configuration=production --baseHref=/ --deployUrl=/
#    - npm run build -- --prod --configuration=production --baseHref=./
    - mv dist/winslow-ui-ng winslow-ui-ng
  artifacts:
    name: winslow-ui-ng_$CI_COMMIT_SHORT_SHA
    paths:
     - winslow-ui-ng

deploy:
  stage: deploy
  only:
    refs:
      - master
  tags:
    - dockerbuilder
  script:
#    - ./build-docker-image.sh
    - ls -lah .
    - docker build . -t $DOCKER_REGISTRY_WINSLOW/winslow/component-html
    - docker login -u $DOCKER_REGISTRY_WINSLOW_USERNAME -p $DOCKER_REGISTRY_WINSLOW_PASSWORD $DOCKER_REGISTRY_WINSLOW
    - docker push $DOCKER_REGISTRY_WINSLOW/winslow/component-html
  dependencies:
    - build

release:
  stage: downstream
  only:
    refs:
      - master
  trigger:
    project: trafficobservation/winslow/docker
    strategy: depend
