build:
  stage: build
  image: maven
  tags:
    - docker
  script:
    - mvn clean test verify package
    - awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, " instructions covered"; print 100*covered/instructions, "% covered" }' target/site/jacoco/jacoco.csv
    - cp target/winslow*.jar .
    - mv target/site/jacoco coverage-report
  coverage: '/([\d]+\.[\d]+) % covered/'
  artifacts:
    name: winslow-$CI_COMMIT_SHORT_SHA
    paths:
     - winslow*.jar
     - coverage-report

deploy:
  stage: deploy
  tags:
    - dockerbuilder
  script:
#    - ./build-docker-image.sh
    - ls -lah .
    - docker build . -t $DOCKER_REGISTRY_WINSLOW/winslow/component-server
    - docker login -u $DOCKER_REGISTRY_WINSLOW_USERNAME -p $DOCKER_REGISTRY_WINSLOW_PASSWORD $DOCKER_REGISTRY_WINSLOW
    - docker push $DOCKER_REGISTRY_WINSLOW/winslow/component-server
  dependencies:
    - build
