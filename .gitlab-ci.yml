stages:
  - build
  - deploy
  - downstream

before_script:
  - git submodule sync --recursive
  - git submodule update --init --recursive
build:
  stage: build
  image: maven:3.6.3-jdk-11
  tags:
    - docker
  script:
    - sed -i "s/external__BUILD_DATE/$(date '+%Y-%m-%d %H:%M:%S')/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
    - sed -i "s/external__COMMIT_HASH_LONG/$CI_COMMIT_SHA/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
    - sed -i "s/external__COMMIT_HASH_SHORT/$CI_COMMIT_SHORT_SHA/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
    - mvn clean test verify package
    - cp application/target/winslow*.jar .
    - mv application/target/site/jacoco coverage-report
    - awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, " instructions covered"; print 100*covered/instructions, "% covered" }' coverage-report/jacoco.csv
    - mvn -pl api package
    - cp api/target/winslow*.jar .
    - mvn -s settings.xml -pl api deploy
  coverage: '/([\d]+\.[\d]+) % covered/'
  artifacts:
    name: winslow-$CI_COMMIT_SHORT_SHA
    paths:
     - winslow*.jar
     - coverage-report

deploy:
  stage: deploy
  only:
    refs:
      - master
  tags:
    - dockerbuilder
  script:
#    - ./build-docker-image.sh
    - ls -lah .
    - docker build . -t $DOCKER_REGISTRY_WINSLOW/winslow/component-server
    - docker login -u $DOCKER_REGISTRY_WINSLOW_USERNAME -p $DOCKER_REGISTRY_WINSLOW_PASSWORD $DOCKER_REGISTRY_WINSLOW
    - docker push $DOCKER_REGISTRY_WINSLOW/winslow/component-server
  dependencies:
    - build

release:
  stage: downstream
  only:
    refs:
      - master
  trigger:
    project: trafficobservation/winslow/docker
    strategy: depend
