stages:
  - build
  - deploy
  - downstream

variables:
  WINSLOW_API_TS_URL_LATEST: "$NEXUS_RAW_WINSLOW_URL/api/winslow-api.ts"

build:
  stage: build
  image: node
  tags:
    - docker
  variables:
    NODE_OPTIONS: "--openssl-legacy-provider"
  script:
    - echo $WINSLOW_API_TS_URL
    - echo $WINSLOW_API_TS_URL_LATEST
    - if [ "$WINSLOW_API_TS_URL" == "" ]; then export WINSLOW_API_TS_URL="$WINSLOW_API_TS_URL_LATEST" ; fi
    - if [ "$WINSLOW_API_TS_URL" != "" ]; then curl -o "src/app/api/winslow-api.ts" -u "$NEXUS_LOGIN" "$WINSLOW_API_TS_URL" ; fi
    - echo $WINSLOW_API_TS_URL
    - echo $WINSLOW_API_TS_URL_LATEST
#    - npm install -g -ng
    - (npm install || (echo "===== eresolve-report.txt =====" && cat /root/.npm/eresolve-report.txt && echo "===== .log =====" && cat /root/.npm/_logs/* && exit 1))
    - npm run build -- --prod --configuration=production --baseHref=/ --deployUrl=/
#    - npm run build -- --prod --configuration=production --baseHref=./
    - mv dist/winslow-ui-ng winslow-ui-ng
  artifacts:
    name: winslow-ui-ng_$CI_COMMIT_SHORT_SHA
    paths:
     - winslow-ui-ng

deploy:
  stage: deploy
  only:
    refs:
      - master
  tags:
    - dockerbuilder
  script:
#    - ./build-docker-image.sh
    - ls -lah .
    - docker build . -t $DOCKER_REGISTRY_WINSLOW/winslow/component-html
    - docker login -u $DOCKER_REGISTRY_WINSLOW_USERNAME -p $DOCKER_REGISTRY_WINSLOW_PASSWORD $DOCKER_REGISTRY_WINSLOW
    - docker push $DOCKER_REGISTRY_WINSLOW/winslow/component-html
  dependencies:
    - build

release:
  stage: downstream
  only:
    refs:
      - master
  trigger:
    project: trafficobservation/winslow/docker
    strategy: depend
