name: CI/CD Pipeline

on:
  push:
    branches:
      - master
      - '**'
    tags:
      - '20**.*'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.short_sha.outputs.sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Get short SHA
        id: short_sha
        run: echo "::set-output name=sha::$(git rev-parse --short=7 ${{ github.sha }})"


  test-component-server:
    needs: prepare
    runs-on: ubuntu-latest
    container:
      image: maven:3.8.5-openjdk-17
    steps:
      - uses: actions/checkout@v2
      - name: Test
        run: |
          mvn clean test verify
          mv application/target/site/jacoco coverage-report
          awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, " instructions covered"; print 100*covered/instructions, "% covered" }' coverage-report/jacoco.csv
        env:
          CI_COMMIT_SHORT_SHA: ${{ needs.prepare.outputs.short_sha }}

  build-component-server:
    needs:
      - test-component-server
      - prepare
    runs-on: ubuntu-latest
    container:
      image: maven:3.8.5-openjdk-17
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Build
        run: |
          sed -i "s/external__BUILD_DATE/$(date '+%Y-%m-%d %H:%M:%S')/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
          sed -i "s/external__COMMIT_HASH_LONG/${{ github.sha }}/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
          sed -i "s/external__COMMIT_HASH_SHORT/${{ needs.prepare.outputs.short_sha }}/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
          mvn clean test verify package
          cp application/target/winslow*.jar .
          mv application/target/site/jacoco coverage-report
          awk -F"," '{ instructions += $4 + $5; covered += $5 } END { print covered, "/", instructions, " instructions covered"; print 100*covered/instructions, "% covered" }' coverage-report/jacoco.csv
          mvn -pl .,api package
          cp api/target/winslow*.jar .
          (cd api; mvn typescript-generator:generate)
          cp api/target/typescript-generator/winslow-api.ts .
          ls -lah
        env:
          CI_COMMIT_SHA: ${{ github.sha }}
          CI_COMMIT_SHORT_SHA: ${{ needs.prepare.outputs.short_sha }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v2
        with:
          name: winslow-${{ github.sha }}
          path: |
            winslow*.jar
            coverage-report
            winslow-api.ts

  publish-component-server-on-artifact-share:
    needs:
      - build-component-server
      - prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Publish
        run: |
          - echo $WINSLOW_API_TS_URL
          - echo $WINSLOW_API_TS_URL_LATEST
          - echo $WINSLOW_API_TS_URL_TAGGED
          - export WINSLOW_API_TS_URL="$(eval echo $WINSLOW_API_TS_URL)"
          - export WINSLOW_API_TS_URL_LATEST="$(eval echo $WINSLOW_API_TS_URL_LATEST)"
          - export WINSLOW_API_TS_URL_TAGGED="$(eval echo $WINSLOW_API_TS_URL_TAGGED)"
          - echo $WINSLOW_API_TS_URL
          - echo $WINSLOW_API_TS_URL_LATEST
          - echo $WINSLOW_API_TS_URL_TAGGED
          - export ARCHIVE=winslow-api.ts
          - ls -lah $ARCHIVE
          - head -n 2 $ARCHIVE
          - curl -i -u "$NEXUS_LOGIN" --upload-file "$ARCHIVE" "$WINSLOW_API_TS_URL"
          - if [ "$CI_COMMIT_REF_NAME" == "master" ]; then curl -i -u "$NEXUS_LOGIN" --upload-file $ARCHIVE "$WINSLOW_API_TS_URL_LATEST"; fi
          - if [ "$CI_COMMIT_TAG" != "" ]; then curl -i -u "$NEXUS_LOGIN" --upload-file $ARCHIVE "$WINSLOW_API_TS_URL_TAGGED"; fi
        env:
          WINSLOW_API_TS_URL: "$NEXUS_RAW_WINSLOW_URL/api/build/winslow-api_$CI_COMMIT_SHORT_SHA.ts"
          WINSLOW_API_TS_URL_LATEST: "$NEXUS_RAW_WINSLOW_URL/api/winslow-api.ts"
          WINSLOW_API_TS_URL_TAGGED: "$NEXUS_RAW_WINSLOW_URL/api/winslow-api.ts"
          NEXUS_LOGIN: ${{ secrets.NEXUS_LOGIN }}
          CI_COMMIT_REF_NAME: ${{ github.ref_name }}
          CI_COMMIT_TAG: ${{ github.ref }}
          # Set your environment variables as needed


#  deploy-component-server:
#    needs:
#      - job: build-component-server
#        artifacts: true
#    only:
#      refs:
#        - master
#        - tags
#        - /^20\d\d.[\d]+$/
#    tags:
#      - dockerbuilder
#    script:
#      - ls -lah .
#      - export TAG="${CI_COMMIT_TAG:-${CI_COMMIT_REF_NAME:-latest}}"
#      - if [ "$TAG" == "master" ]; then export TAG="latest"; fi
#      - echo $TAG
#      - docker build . -t $DOCKER_REGISTRY_WINSLOW/winslow/component-server:$TAG
#      - docker login -u $DOCKER_REGISTRY_WINSLOW_USERNAME -p $DOCKER_REGISTRY_WINSLOW_PASSWORD $DOCKER_REGISTRY_WINSLOW
#      - docker push $DOCKER_REGISTRY_WINSLOW/winslow/component-server:$TAG

  build-component-html:
    needs:
      - build-component-server
    runs-on: ubuntu-latest
    container:
      image: node:20
    steps:
       - uses: actions/download-artifact@v2
         with:
           name: winslow-${{ github.sha }}
           path: |
              winslow*.jar
              coverage-report
              winslow-api.ts
       - uses: actions/checkout@v2
       - name: Build
         run: |
            mv winslow-api.ts ui-ng/src/app/api/winslow-api.ts
            cd ui-ng
            npm install
            npm run build --prod --configuration=production --baseHref=/ --deployUrl=/
            mv dist/winslow-ui-ng ../winslow-ui-ng
       - uses: actions/upload-artifact@v2
         with:
          name: winslow-ui-ng_${{ github.sha }}
          path: winslow-ui-ng

#deploy-component-html:
#  needs:
#    - job: build-component-html
#      artifacts: true
#  only:
#    refs:
#      - master
#      - tags
#      - /^20\d\d.[\d]+$/
#  tags:
#    - dockerbuilder
#  script:
#    - mv winslow-ui-ng ui-ng/winslow-ui-ng
#    - cd ui-ng
#    - ls -lah .
#    - export TAG="${CI_COMMIT_TAG:-${CI_COMMIT_REF_NAME:-latest}}"
#    - if [ "$TAG" == "master" ]; then export TAG="latest"; fi
#    - echo $TAG
#    - docker build . -t $DOCKER_REGISTRY_WINSLOW/winslow/component-html:$TAG
#    - docker login -u $DOCKER_REGISTRY_WINSLOW_USERNAME -p $DOCKER_REGISTRY_WINSLOW_PASSWORD $DOCKER_REGISTRY_WINSLOW
#    - docker push $DOCKER_REGISTRY_WINSLOW/winslow/component-html:$TAG
#
#
#deploy-winslow-node:
#  needs:
#    - deploy-component-server
#    - deploy-component-html
#  only:
#    refs:
#      - master
#      - tags
#      - /^20\d\d.[\d]+$/
#  tags:
#    - dockerbuilder
#  script:
#    - export TAG="${CI_COMMIT_TAG:-${CI_COMMIT_REF_NAME:-latest}}"
#    - if [ "$TAG" == "master" ]; then export TAG="latest"; fi
#    - echo $TAG
#    - cd node
#    - docker pull nexus.itd-intern.de/winslow/component-html:$TAG
#    - docker pull nexus.itd-intern.de/winslow/component-server:$TAG
#    - docker build . -t $DOCKER_REGISTRY_WINSLOW/winslow/node:$TAG
#      --build-arg COMPONENT_HTML=nexus.itd-intern.de/winslow/component-html:$TAG
#      --build-arg COMPONENT_SERVER=nexus.itd-intern.de/winslow/component-server:$TAG
#    - docker login -u $DOCKER_REGISTRY_WINSLOW_USERNAME -p $DOCKER_REGISTRY_WINSLOW_PASSWORD $DOCKER_REGISTRY_WINSLOW
#    - docker push $DOCKER_REGISTRY_WINSLOW/winslow/node:$TAG
