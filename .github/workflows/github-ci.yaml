name: CI/CD Pipeline
env:
  IMAGE_NAME_HTML: ${{ vars.DOCKER_REGISTRY_WINSLOW }}:component-html-latest
  IMAGE_NAME_SERVER: ${{ vars.DOCKER_REGISTRY_WINSLOW }}:component-server-latest
  IMAGE_NAME: ${{ vars.DOCKER_REGISTRY_WINSLOW }}:latest
on:
  push:
    branches:
      - master
      - '**'
    tags:
      - '20**.*'
  workflow_dispatch:
    branches: '**'

jobs:
  test-component-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      - name: Test
        run: |
          mvn clean test verify
          # TODO: Add coverage report

  build-component-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      - name: Setup 'Build.java' information
        run: |
          export COMMIT_HASH_LONG=${{ github.sha }}
          export COMMIT_HASH_SHORT=$(git rev-parse --short=7 ${{ github.sha }})
          sed -i "s/external__BUILD_DATE/$(date '+%Y-%m-%d %H:%M:%S')/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
          sed -i "s/external__COMMIT_HASH_LONG/${{ github.sha }}/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
          sed -i "s/external__COMMIT_HASH_SHORT/$COMMIT_HASH_SHORT}/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
      - name: Build
        run: |
          mvn clean verify package -DskipTests
      - name: Prepare upload jar files
        run: |
          cp application/target/winslow*.jar .
          cp api/target/winslow*.jar .
      - name: Upload jar files
        uses: actions/upload-artifact@v4
        with:
          retention-days: 1
          compression-level: 9
          name: jar-files-${{ github.run_id }}
          path: |
            winslow*.jar

  build-component-html:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      - name: create winslow-api.ts
        run: |
          cd api
          mvn compile typescript-generator:generate
          cd ..
      - name: copy winslow-api.ts to ui-ng
        run: |
          cp api/target/typescript-generator/winslow-api.ts ui-ng/src/app/api/winslow-api.ts
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ui-ng/package-lock.json
      - name: Prepare build
        run: |
          cd ui-ng
          npm install
      - name: Build
        run: |
          cd ui-ng
          npm run build --prod --configuration=production --baseHref=/ --deployUrl=/
      - name: Prepare upload
        run: |
          cd ui-ng
          mv dist/winslow-ui-ng ../winslow-ui-ng
      - name: Upload winslow-ui-ng
        uses: actions/upload-artifact@v4
        with:
          retention-days: 1
          compression-level: 9
          name: winslow-ui-ng_${{ github.run_id }}
          path: winslow-ui-ng

  deployment-condition-check:
    needs:
      - build-component-server
      - test-component-server
      - build-component-html
    if: github.ref == 'refs/heads/239-create-a-workflow-file-for-github' ||
      github.ref == 'master' ||
      github.ref == 'refs/tags/20**.*'
    runs-on: ubuntu-latest
    steps:
    - name: Check
      run: |
        echo "Deployment condition check passed" 
        echo "github.ref == 'refs/heads/239-create-a-workflow-file-for-github' || github.ref == 'master' || github.ref == 'refs/tags/20**.*'"

  deploy-component-server:
    needs:
      - deployment-condition-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: jar-files-${{ github.run_id }}
          path: .
      - name: Publish
        run: |
          docker build . -t $IMAGE_NAME
          docker login -u ${{ secrets.DOCKER_REGISTRY_WINSLOW_USERNAME }} -p ${{ secrets.DOCKER_REGISTRY_WINSLOW_PASSWORD }}
          docker push $IMAGE_NAME
# TODO: adjust image name to github repo. so with 2024.1 it will be the tag and not latest
# and the master/main will go to the latest tag
# do this for all github images, and for tags(git tags)

  deploy-component-html:
    runs-on: ubuntu-latest
    needs:
      - deployment-condition-check
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: winslow-ui-ng_${{ github.run_id }}
          path: ./winslow-ui-ng
      - name: Publish
        run: |
          mv winslow-ui-ng ui-ng/winslow-ui-ng
          cd ui-ng
          docker build . -t $IMAGE_NAME
          docker login -u ${{ secrets.DOCKER_REGISTRY_WINSLOW_USERNAME }} -p ${{ secrets.DOCKER_REGISTRY_WINSLOW_PASSWORD }} 
          docker push $IMAGE_NAME

  deploy-winslow-node:
    runs-on: ubuntu-latest
    needs:
      - deploy-component-server
      - deploy-component-html
    steps:
      - uses: actions/checkout@v4
      - name: Publish
        run: |
          cd node
          docker login -u ${{ secrets.DOCKER_REGISTRY_WINSLOW_USERNAME }} -p ${{ secrets.DOCKER_REGISTRY_WINSLOW_PASSWORD }}
          docker pull $IMAGE_NAME_HTML
          docker pull $IMAGE_NAME_SERVER
          docker build . -t $IMAGE_NAME --build-arg COMPONENT_HTML=$IMAGE_NAME_HTML --build-arg COMPONENT_SERVER=$IMAGE_NAME_SERVER
          docker push $IMAGE_NAME
