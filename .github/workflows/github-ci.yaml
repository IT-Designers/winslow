name: CI/CD Pipeline
env:
  IMAGE_NAME_HTML: component-html
  IMAGE_NAME_SERVER: component-server
on:
  push:
    branches:
      - master
      - '**'
    tags:
      - '20**.*'
  workflow_dispatch:
    branches:
      - '**'

jobs:
  test-component-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      - name: Test
        run: |
          mvn clean test verify
          # TODO: Add coverage report

  build-component-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      - name: Setup 'Build.java' information
        run: |
          export COMMIT_HASH_LONG=${{ github.sha }}
          export COMMIT_HASH_SHORT=$(git rev-parse --short=7 ${{ github.sha }})
          sed -i "s/external__BUILD_DATE/$(date '+%Y-%m-%d %H:%M:%S')/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
          sed -i "s/external__COMMIT_HASH_LONG/${{ github.sha }}/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
          sed -i "s/external__COMMIT_HASH_SHORT/$COMMIT_HASH_SHORT}/g" api/src/main/java/de/itdesigners/winslow/api/Build.java
      - name: Build
        run: |
          mvn clean verify package -DskipTests
      - name: Prepare upload jar files
        run: |
          cp application/target/winslow*.jar .
          cp api/target/winslow*.jar .
      - name: Upload jar files
        uses: actions/upload-artifact@v4
        with:
          retention-days: 1
          compression-level: 9
          name: jar-files-${{ github.run_id }}
          path: |
            winslow*.jar

  build-component-html:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      - name: create winslow-api.ts
        run: |
          cd api
          mvn compile typescript-generator:generate
          cd ..
      - name: copy winslow-api.ts to ui-ng
        run: |
          cp api/target/typescript-generator/winslow-api.ts ui-ng/src/app/api/winslow-api.ts
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
             ui-ng/package-lock.json
             ui-ng/.subtree/ngx-sweetalert2/package-lock.json
      - name: Prepare build
        run: |
          cd ui-ng
          npm install
      - name: Build
        run: |
          cd ui-ng
          npm run build --prod --configuration=production --baseHref=/ --deployUrl=/
      - name: Prepare upload
        run: |
          cd ui-ng
          mv dist/winslow-ui-ng ../winslow-ui-ng
      - name: Upload winslow-ui-ng
        uses: actions/upload-artifact@v4
        with:
          retention-days: 1
          compression-level: 9
          name: winslow-ui-ng_${{ github.run_id }}
          path: winslow-ui-ng

  deploy-winslow-node:
    runs-on: ubuntu-latest
    needs:
      - build-component-server
      - test-component-server
      - build-component-html
    if: github.ref == 'master' ||
      github.ref == 'refs/heads/20**.*' ||
      github.ref == 'refs/tags/20**.*'
    steps:
      - uses: actions/checkout@v4

      - name: Download backend
        uses: actions/download-artifact@v4
        with:
          name: jar-files-${{ github.run_id }}
          path: .
      - name: Build backend image
        run: |
          docker build . -t $IMAGE_NAME_SERVER

      - name: Download frontend
        uses: actions/download-artifact@v4
        with:
          name: winslow-ui-ng_${{ github.run_id }}
          path: ./winslow-ui-ng
      - name: Build frontend image
        run: |
          mv winslow-ui-ng ui-ng/winslow-ui-ng
          cd ui-ng
          docker build . -t $IMAGE_NAME_HTML

      - name: Dockerhub login
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_REGISTRY_WINSLOW_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_REGISTRY_WINSLOW_PASSWORD }}
        run: |
          echo "${DOCKER_PASSWORD}" | docker login --username ${DOCKER_USERNAME} --password-stdin

      - name: Build final image
        run: |
          cd node
          TAG=$(echo ${GITHUB_REF##*/} | sed 's/[^a-zA-Z0-9]/./g')
          echo $TAG
          IMAGE_NAME=${{ vars.DOCKER_REGISTRY_WINSLOW }}
          echo $IMAGE_NAME
          echo $IMAGE_NAME:$TAG
          docker build . -t $IMAGE_NAME:$TAG --build-arg COMPONENT_HTML=$IMAGE_NAME_HTML --build-arg COMPONENT_SERVER=$IMAGE_NAME_SERVER
          docker push $IMAGE_NAME:$TAG
          docker tag $IMAGE_NAME:$TAG $IMAGE_NAME:latest
          docker push $IMAGE_NAME:latest
#### TODO: when to use latest and when to use the tag name from git?
#### each push on 2024.1 will create a tag latest and 2024.1 / the last push on 2024.1 will automatically create a tag latest
#### when a 2025.1 branch is created then it will be latest and 2025.1 so the 2024.1 will not change and is not latest anymore
#### or should it be like latest is the last push on master/main and the tag is the tag from git?
