<mat-card>
  <mat-card-title>Filter</mat-card-title>

  <mat-card-content class="flex-grow-row tag-filter">
    <div>
      <mat-card-subtitle>Projects that <strong>include</strong> the following tags</mat-card-subtitle>
      <app-tags-with-autocomplete [proposals]="this.api.cachedTags"
                                  (tags)="this.includeTags = $event; updateFilter()"
      ></app-tags-with-autocomplete>
      <mat-slide-toggle (change)="includeEmpty = $event.checked; updateFilter()">
        Include with no Tags
      </mat-slide-toggle>
    </div>
    <div>
      <mat-card-subtitle>Projects that <strong>exclude</strong> the following tags</mat-card-subtitle>
      <app-tags-with-autocomplete [proposals]="this.api.cachedTags"
                                  (tags)="this.excludeTags = $event; updateFilter()"
      ></app-tags-with-autocomplete>
      <mat-slide-toggle (change)="excludeEmpty = $event.checked; updateFilter()">
        Exclude with no Tags
      </mat-slide-toggle>
    </div>
  </mat-card-content>
</mat-card>

<mat-card>
  <mat-card-title>Matching Projects</mat-card-title>
  <mat-card-content>
    <mat-list>
      <mat-list-item *ngFor="let project of filtered">
        <app-project-view-header
          [project]="project"
          [running]="false"
          [progress]="null"
          [pauseReason]="null">
        </app-project-view-header>
      </mat-list-item>
    </mat-list>
    <div *ngIf="projects != null && projects.length == 0" class="none-defined-yet">
      <i>There are no projects matching your filter</i>
    </div>
    <app-loading-info [error]="projectsLoadError != null ? projectsLoadError.message : null"
                      [loading]="projectsLongLoading.isLongLoading()"></app-loading-info>
  </mat-card-content>
</mat-card>

<mat-card>
  <mat-card-title>Stage Execution</mat-card-title>
  <mat-card-content class="flex-grow-column action-selector">
    <div *ngIf="pipelines != null" class="action-row">
      <mat-label class="title">Pipeline</mat-label>
      <mat-form-field>
        <mat-select (selectionChange)="loadStagesForPipeline($event.value)">
          <mat-option *ngFor="let pipeline of pipelines" [value]="pipeline.id">{{pipeline.name}}</mat-option>
        </mat-select>
      </mat-form-field>
      <div class="controls"></div>
    </div>

    <div *ngIf="selectedPipeline != null" class="action-row">
      <mat-label class="title pipeline-to-stage-indention">Stage</mat-label>
      <mat-form-field>
        <mat-select (selectionChange)="loadEnvForStageName($event.value)">
          <mat-option *ngFor="let stage of selectedPipeline.stages" [value]="stage.name">{{stage.name}}</mat-option>
        </mat-select>
      </mat-form-field>
      <div class="controls"></div>
    </div>

    <ng-container *ngIf="selectedPipeline != null && selectedStage != null && selectedStage.image != null">
      <div>
        <mat-divider></mat-divider>
      </div>
      <div class="whitespace-separator-top">
        <mat-card-subtitle>Image Information</mat-card-subtitle>
      </div>
      <div class="action-row">
        <mat-label class="title">Image Name</mat-label>
        <mat-form-field>
          <input matInput [value]="selectedStage.image.name">
        </mat-form-field>
        <div class="controls">
          <button dense mat-stroked-button color="primary">Reset</button>
        </div>
      </div>
      <div class="action-row">
        <mat-label class="title">Image Args</mat-label>
        <mat-form-field>
          <input matInput [value]="getSelectedImageArgs()">
        </mat-form-field>
        <div class="controls">
          <button dense mat-stroked-button color="primary">Reset</button>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="environmentVariables != null">
      <div>
        <mat-divider></mat-divider>
      </div>
      <div class="whitespace-separator-top">
        <mat-card-subtitle>Environment Variables</mat-card-subtitle>
      </div>
      <div *ngFor="let envVar of environmentVariables | keyvalue" class="action-row">
        <mat-label class="title">{{envVar.key}}</mat-label>
        <mat-form-field>
          <input #value matInput [required]="envVar.value[0]" name="{{envVar.key}}" [value]="envVar.value[1]">
        </mat-form-field>
        <div class="controls">
          <button mat-stroked-button color="primary" (click)="browseForValue(value)">
            <mat-icon class="material-icons-outlined">folder</mat-icon>
          </button>
          <button mat-button color="warn" [disabled]="envVar.value[0]"
                  [matTooltip]="envVar.value[0] ? 'This value is required' : null"
                  (click)="environmentVariables.delete(envVar.key)">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
      <div class="action-row">
        <mat-form-field class="title">
          <input matInput placeholder="Name" #name>
        </mat-form-field>
        <mat-form-field>
          <input matInput placeholder="Value" #value>
        </mat-form-field>
        <div class="controls">
          <button mat-stroked-button color="primary" (click)="browseForValue(value)">
            <mat-icon class="material-icons-outlined">folder</mat-icon>
          </button>
          <button dense mat-raised-button color="primary" #button
                  [disabled]="name.value.trim().length == 0 || value.value.trim().length == 0"
                  (click)="environmentVariables.set(name.value.trim(), [false, value.value.trim()]); name.value = null; value.value = null">
            Add
          </button>
        </div>
      </div>
    </ng-container>


    <ng-container *ngIf="selectedPipeline != null && selectedStage != null">
      <div>
        <mat-divider></mat-divider>
      </div>
      <div class="whitespace-separator-top">
        <mat-card-subtitle>Submission</mat-card-subtitle>
      </div>
      <div class="action-row">
        <div class="title"></div>
        <div class="centered-controls">
          <button mat-stroked-button color="primary">Add by appending to queues</button>
          <button mat-stroked-button color="warn">Add by replacing existing queues</button>
        </div>
        <div class="controls"></div>
      </div>
    </ng-container>

    <app-loading-info [error]="actionLoadError != null ? actionLoadError.message : null"
                      [loading]="actionLongLoading.isLongLoading()"></app-loading-info>
  </mat-card-content>
</mat-card>
